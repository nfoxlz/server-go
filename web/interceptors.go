// interceptors
package web

import (
	"strconv"
	"strings"

	"server/components"
	"server/repositories"
	"server/util"

	"github.com/kataras/iris/v12"
)

func getCookie(ctx iris.Context, name string) (int64, error) {

	cookie, err := ctx.GetRequestCookie(name)
	if nil != err {
		util.LogError(err)
		return 0, err
	}

	value, err := util.AESDecryptWithRandString(cookie.Value)
	if nil != err {
		util.LogError(err)
		return 0, err
	}

	id, err := strconv.ParseInt(string(value), 10, 64)
	if nil != err {
		util.LogError(err)
		return 0, err
	}

	return id, nil
}

func AuthorizationInterceptor() iris.Handler {
	return func(ctx iris.Context) {
		path := ctx.Path()
		if !strings.HasPrefix(path, "/api/Account/") && !strings.HasPrefix(path, "/api/public/") {

			tenantId, err := getCookie(ctx, components.TenantToken)
			if nil != err {
				return
			}

			var repository repositories.TenantRepository
			tenant, err := repository.GetTenant(tenantId)
			if nil != err || tenant.Id == 0 {
				return
			}

			userId, err := getCookie(ctx, components.UserToken)
			if nil != err {
				return
			}

			// var data map[string]interface{}
			// ctx.ReadJSON(&data)
			// ctx.Values().Set("jsonData", data)
			// util.LogDebug("=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================")
			// var data map[string]interface{}
			// if err := ctx.ReadJSON(&data); err != nil {
			// 	// ctx.StopWithError(iris.StatusBadRequest, err)
			// 	// return
			// }
			// util.LogDebug(data)
			// util.LogDebug("=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================")

			ctx.Values().Set(components.TenantToken, tenant)
			ctx.Values().Set(components.UserToken, userId)
		}

		ctx.Values().Set(components.DataSignature, ctx.GetHeader(components.DataSignature))

		ctx.Next()
	}
}
